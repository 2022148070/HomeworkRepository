<!DOCTYPE html>
<html>

<head>
    <title>index</title>
    <link rel="stylesheet" type="text/css" href="main.css">
</head>

<body>
    <header>
        <div>
            <h1>안녕하세요 마켓컬리입니다.</h1>
        </div>
    </header>
    <nav>
        <div class="navbar">
            <a href="index.html">메인페이지</a>
            <a href="login.html">로그인</a>
            <a href="signup.html">회원가입</a>
        </div>
    </nav>
    <section class="flex-container-row">
        <div class="flex-container-column search">
            <p><label>Choose a category:
                    <br /><select id="category">
                        <option selected>All</option>
                        <option>even</option>
                        <option>odd</option>
                    </select></label></p>
            <p><label>Enter search term:
                    <br /><input type="text" id="term">
                </label></p>
            <p><label>Choose a sort:
                    <br /><select id="sort">
                        <option selected>none</option>
                        <option>up</option>
                    </select></label></p>
            <input type="submit" value="Filter results" id="searchbutton" />
        </div>
        <div id="products"></div>
    </section>
    <footer>
        여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리
        여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리
        여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리
        여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리
        여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리
        여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리
        여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리
        여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리 여기는 마켓컬리
    </footer>
    <script>

        fetch('product.json')
            .then(response => response.json())
            .then(json => main(json));

        function main(data) {
            var product = data;

            const itemarea = document.getElementById("products");
            function filtering(e) {
                e.preventDefault();
                product = [];
                const type = document.getElementById("category").value;
                const keyword = document.getElementById("term").value;
                const ifsort = document.getElementById("sort").value;

                console.log(type, keyword);

                if (type == "All") {
                    if (keyword === null)
                        product = data;
                    else
                        for (let i = 0; i < data.length; i++)
                            if (data[i].name.includes(keyword))
                                product.push(data[i]);
                }
                else {
                    if (keyword === null) {
                        for (let i = 0; i < data.length; i++)
                            if (data[i].type == type)
                                product.push(data[i]);
                    }
                    else
                        for (let i = 0; i < data.length; i++)
                            if (data[i].type == type && data[i].name.includes(keyword))
                                product.push(data[i]);
                }

                if (ifsort == "up")
                    data.sort(function (a, b) {
                        if (a.price > b.price) return 1;
                        if (a.price === b.price) return 0;
                        if (a.price < b.price) return -1;
                    });

                while (itemarea.hasChildNodes())
                    itemarea.removeChild(itemarea.firstChild);
                show_init(product);
            }

            show_init(data);
            document.getElementById("searchbutton").onclick = filtering;

            function show_init(product) {
                for (let i = 0; i < product.length; i++) {
                    if (i < 6) {
                        let div = document.createElement('div');
                        let img = document.createElement('img');

                        div.className = 'item';
                        div.id = 'item ' + product[i].name;
                        div.addEventListener('click', showContents);

                        img.id = 'phot ' + product[i].name;
                        img.src = product[i].img;
                        img.alt = product[i].name;

                        itemarea.appendChild(div);
                        div.appendChild(img);
                    }
                }
            }

            function showContents(e) {
                let product_name = e.currentTarget.id.substr(5);
                if (document.getElementById('phot ' + product_name).style.opacity != 0.4) {
                    for (let i = 0; i < data.length; i++) {
                        if (product_name == data[i].name) {
                            document.getElementById('phot ' + product_name).style.opacity = 0.4;
                            let elem = document.createElement('p');
                            elem.innerHTML = data[i].name + " <br> " + data[i].price;
                            document.getElementById('item ' + product_name).appendChild(elem);
                            break;
                        }
                    }
                }
            }

            window.onscroll = () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
                    let elem_num = document.getElementById("products").childElementCount;
                    let new_product = product.slice(elem_num);
                    for (let i = 0; i < new_product.length; i++) {
                        if (i < 6) {
                            let div = document.createElement('div');
                            let img = document.createElement('img');

                            div.className = 'item';
                            div.id = 'item ' + new_product[i].name;
                            div.addEventListener('click', showContents);

                            img.id = 'phot ' + new_product[i].name;
                            img.src = new_product[i].img;
                            img.alt = new_product[i].name;

                            document.getElementById("products").appendChild(div);
                            div.appendChild(img);
                        }
                    }
                }
            }
        }
    </script>
</body>

</html>